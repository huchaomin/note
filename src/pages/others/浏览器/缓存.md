---
title: 缓存
markmap: true
---

# 浏览器缓存

## 缓存的分类

### service worker

#### 是运行在浏览器背后的独立线程，独立于当前页面，拥有自己的生命周期，一般可以用来实现缓存功能

##### 传输协议必须为HTTPS

##### 与浏览器其他内建的缓存机制不同，它可以让我们自由控制缓存的逻辑，比如缓存的时长、缓存的资源类型等并且缓存时可持续性的

##### 如果我们没有在service worker中命中缓存的话，浏览器会继续使用HTTP缓存机制，但是浏览器都会显示我们是从service worker中获取的资源

### memory cache

#### 内存缓存

##### 即使我们不设置缓存，如果当前的空间比较充裕的话，一些资源还是会被缓存下来

##### 这种缓存是暂时的，一旦关闭了tab这一部分用于缓存的内存就会被释放

##### 比较高效，但是还是受限于计算机内存的大小，所以让我们使用的内存并不多

##### 不受 `max-age`、`no-cache` 等配置的影响

##### 受 `no-store` 的影响

### disk cache

#### 磁盘缓存

##### 比 memory cache 更加持久，即使我们关闭了浏览器，下次再打开的时候，这些缓存可能依然存在

##### 如果当前 memory cache 占用内存过多的话，请求资源大概率会被缓存到 disk cache 中

##### 受header缓存配置的影响

### push cache

#### 推送缓存

##### 是 HTTP/2 中的一个概念，它是一种服务器主动推送资源的机制，以上三种缓存都没有命中时，他才会被使用

##### 服务器可以在客户端请求资源的时候，主动推送一些资源给客户端

##### 他只有在会话（session）中存在，一旦会话结束，这些缓存就会被清除，并且缓存时间也很短暂

##### 但是这种机制并不是所有的浏览器都支持，chrome 中只有5分钟左右，同时他也并非严格执行HTTP头部中的缓存指令

### 强缓存

#### 优先于协商缓存，如果命中强缓存，直接从缓存中读取资源，不会发请求到服务器

##### Expires(http1.0)

###### 缓存过期时间，是服务器端的具体时间，如果在这个时间之前，直接从缓存中读取资源，不会发请求到服务器

###### 优先级低于 Cache-Control

##### Cache-Control(http1.1)

###### 可以在请求头或者响应头中设置，并且可以组合使用

- `public`
  - 所有内容都将被缓存（客户端和代理服务器都可缓存）
- `private`
  - 所有内容只有客户端可以缓存，Cache-Control的默认取值
- `no-cache`
  - 客户端缓存内容，但是是否使用缓存则需要经过协商缓存来验证决定(名字有点歧义)
- `no-store`
  - 所有内容都不会被缓存，即不使用强制缓存，也不使用协商缓存(memory cache 也会被清除)
- `max-age=xxx`
  - 缓存内容将在 xxx 秒后失效
- `s-maxage=xxx`
  - 作用同 `max-age=xxx`， 仅代理服务器可用
  - 如果存在，则会覆盖掉 `max-age=xxx` 和 `Expires`
- `max-stale=xxx`
  - 客户端能容忍的最大过期时间
- `min-fresh=xxx`
  - 客户端能容忍的最小新鲜时间(太新鲜了不要)

### 协商缓存

#### 如果命中协商缓存，会发请求到服务器，服务器会根据请求头中的一些字段来判断是否命中协商缓存，如果命中，返回304，不命中，返回200和新的资源

##### Last-Modified/If-Modified-Since

###### 服务器在响应请求时，会在响应头中加上 Last-Modified 字段，表示资源最后修改的时间

###### 客户端在下次请求时，会在请求头中加上 If-Modified-Since 字段，表示上次请求时服务器返回的 Last-Modified 字段的值

###### 服务器收到请求后，会将 If-Modified-Since 字段的值与资源的最后修改时间进行对比，如果一致，则命中协商缓存，返回304，否则返回200和新的资源

###### 优先级低于 Etag

##### Etag/If-None-Match

###### 服务器在响应请求时，会在响应头中加上 Etag 字段，表示资源的唯一标识

###### 只要资源有变化，Etag 就会重新生成

###### 客户端在下次请求时，会在请求头中加上 If-None-Match 字段，表示上次请求时服务器返回的 Etag 字段的值

###### 服务器收到请求后，会将 If-None-Match 字段的值与资源的 Etag 进行对比，如果一致，则命中协商缓存，返回304，否则返回200和新的资源

## 浏览器缓存的最佳实践

### 频繁变动的资源

#### `Cache-Control: no-cache` + 协商缓存

##### 虽然不能节省请求数量，但是能显著减少响应数据大小

### 不常变化的资源

#### `Cache-Control: max-age=31536000` (1年) + hash

##### 请求相同的的URL会命中强缓存，而为了解决更新问题，就需要在文件名中添加hash,之后更新hash,从而达到更改请求路径的目的

## 用户行为对浏览器缓存的影响

### 打开网页，地址栏输入地址

#### 查找dist cache，如果命中，直接从缓存中读取资源，不会发请求到服务器

### 普通刷新(f5)

#### 因为TAB没有关闭，因此 memory cache 依然存在，因此优先被使用，其次才是dist cache

### 强制刷新(ctrl+f5)

#### 浏览器不使用缓存，发送的头部均带有 `Cache-Control: no-cache`(为了兼容还带了 `Pragma: no-cache`)，服务器直接返回200和新的资源
